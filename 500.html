
{% extends "base.html" %}

{% block title %}Lỗi hệ thống - CoachEduAI{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 text-center">
            <!-- Error Icon -->
            <div class="error-icon mb-4">
                <i class="fas fa-exclamation-triangle fa-5x text-danger"></i>
            </div>
            
            <!-- Error Content -->
            <div class="error-content mb-5">
                <h1 class="display-1 fw-bold text-danger mb-3">500</h1>
                <h2 class="h3 fw-bold mb-3">Lỗi máy chủ nội bộ</h2>
                <p class="lead text-muted mb-4">
                    Đã xảy ra lỗi hệ thống không mong muốn. Chúng tôi đã được thông báo về sự cố này 
                    và đang khắc phục. Vui lòng thử lại sau ít phút.
                </p>
            </div>
            
            <!-- Action Buttons -->
            <div class="error-actions mb-5">
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <a href="{{ url_for('home' if session.user_id else 'index') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-home me-2"></i>Về trang chủ
                    </a>
                    <button onclick="location.reload()" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-refresh me-2"></i>Thử lại
                    </button>
                    <button onclick="reportError()" class="btn btn-outline-danger btn-lg">
                        <i class="fas fa-bug me-2"></i>Báo lỗi
                    </button>
                </div>
            </div>
            
            <!-- Error Details -->
            <div class="error-details mb-5">
                <details class="mb-4">
                    <summary class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-info-circle me-2"></i>Chi tiết kỹ thuật
                    </summary>
                    <div class="tech-details mt-3 p-3 bg-light rounded text-start">
                        <p class="mb-2"><strong>Mã lỗi:</strong> HTTP 500</p>
                        <p class="mb-2"><strong>Thời gian:</strong> <span id="error-time"></span></p>
                        <p class="mb-2"><strong>Trang:</strong> <span id="error-url"></span></p>
                        <p class="mb-2"><strong>Trình duyệt:</strong> <span id="user-agent"></span></p>
                        <p class="mb-0"><strong>ID lỗi:</strong> <span id="error-id"></span></p>
                    </div>
                </details>
            </div>
            
            <!-- Status Check -->
            <div class="status-check mb-5">
                <div class="card border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-warning">
                            <i class="fas fa-server me-2"></i>Trạng thái hệ thống
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                                    <span class="small">Cơ sở dữ liệu</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                                    <span class="small">Máy chủ web</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                                    <span class="small">CDN</span>
                                </div>
                            </div>
                        </div>
                        <p class="mt-3 mb-0 small text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Cập nhật lần cuối: <span id="last-update"></span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Alternative Actions -->
            <div class="alternative-actions">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-lightbulb me-2"></i>Trong lúc chờ đợi, bạn có thể:
                        </h5>
                        <div class="row g-3">
                            {% if session.user_id %}
                            <div class="col-md-4">
                                <a href="{{ url_for('profile') }}" class="text-decoration-none">
                                    <div class="d-flex align-items-center p-3 bg-light rounded hover-effect">
                                        <i class="fas fa-user text-primary me-3 fa-2x"></i>
                                        <div>
                                            <h6 class="mb-1">Xem hồ sơ</h6>
                                            <small class="text-muted">Kiểm tra thông tin cá nhân</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-4">
                                <a href="{{ url_for('ranking') }}" class="text-decoration-none">
                                    <div class="d-flex align-items-center p-3 bg-light rounded hover-effect">
                                        <i class="fas fa-trophy text-warning me-3 fa-2x"></i>
                                        <div>
                                            <h6 class="mb-1">Xếp hạng</h6>
                                            <small class="text-muted">Xem bảng xếp hạng</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-4">
                                <a href="{{ url_for('notifications') }}" class="text-decoration-none">
                                    <div class="d-flex align-items-center p-3 bg-light rounded hover-effect">
                                        <i class="fas fa-bell text-info me-3 fa-2x"></i>
                                        <div>
                                            <h6 class="mb-1">Thông báo</h6>
                                            <small class="text-muted">Kiểm tra tin tức mới</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% else %}
                            <div class="col-md-6">
                                <a href="{{ url_for('login') }}" class="text-decoration-none">
                                    <div class="d-flex align-items-center p-3 bg-light rounded hover-effect">
                                        <i class="fas fa-sign-in-alt text-primary me-3 fa-2x"></i>
                                        <div>
                                            <h6 class="mb-1">Đăng nhập</h6>
                                            <small class="text-muted">Truy cập tài khoản</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="{{ url_for('register_step1') }}" class="text-decoration-none">
                                    <div class="d-flex align-items-center p-3 bg-light rounded hover-effect">
                                        <i class="fas fa-user-plus text-success me-3 fa-2x"></i>
                                        <div>
                                            <h6 class="mb-1">Đăng ký</h6>
                                            <small class="text-muted">Tạo tài khoản mới</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Support Contact -->
            <div class="support-info mt-4">
                <p class="text-muted mb-3">
                    <i class="fas fa-headset me-2"></i>
                    Nếu lỗi vẫn tiếp tục, vui lòng liên hệ đội hỗ trợ:
                </p>
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="contactSupport()">
                        <i class="fas fa-envelope me-2"></i>support@coachedual.com
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="openLiveChat()">
                        <i class="fas fa-comments me-2"></i>Chat trực tuyến
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="checkStatus()">
                        <i class="fas fa-globe me-2"></i>Trang trạng thái
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hover-effect {
    transition: all 0.3s ease;
}

.hover-effect:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.error-icon {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
    100% {
        transform: scale(1);
    }
}

.status-indicator {
    animation: blink 2s infinite;
}

@keyframes blink {
    0%, 50% {
        opacity: 1;
    }
    51%, 100% {
        opacity: 0.3;
    }
}

.display-1 {
    font-size: 6rem;
}

@media (max-width: 768px) {
    .display-1 {
        font-size: 4rem;
    }
    
    .error-actions .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}

.tech-details {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}
</style>

<script>
function reportError() {
    const errorDetails = {
        url: window.location.href,
        time: new Date().toISOString(),
        userAgent: navigator.userAgent,
        errorId: generateErrorId()
    };
    
    // Send error report
    if (confirm('Bạn có muốn gửi báo cáo lỗi không? Điều này sẽ giúp chúng tôi khắc phục nhanh hơn.')) {
        // In a real app, this would send data to an error reporting service
        alert('Cảm ơn bạn! Báo cáo lỗi đã được gửi. ID: ' + errorDetails.errorId);
    }
}

function contactSupport() {
    const errorId = generateErrorId();
    window.location.href = `mailto:support@coachedual.com?subject=Lỗi 500 - ${errorId}&body=Xin chào, tôi gặp lỗi 500 khi truy cập: ${window.location.href}%0A%0AID lỗi: ${errorId}%0AThời gian: ${new Date().toLocaleString()}`;
}

function openLiveChat() {
    {% if session.user_id %}
    window.location.href = '{{ url_for("chat") }}';
    {% else %}
    alert('Vui lòng đăng nhập để sử dụng chat hỗ trợ!');
    {% endif %}
}

function checkStatus() {
    window.open('https://status.coachedual.com', '_blank');
}

function generateErrorId() {
    return 'ERR-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
}

function updateSystemStatus() {
    // Simulate system status check
    const indicators = document.querySelectorAll('.status-indicator');
    indicators.forEach((indicator, index) => {
        setTimeout(() => {
            const statuses = ['bg-success', 'bg-warning', 'bg-danger'];
            const currentStatus = statuses[Math.floor(Math.random() * statuses.length)];
            indicator.className = `status-indicator ${currentStatus} rounded-circle me-2`;
        }, index * 500);
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set error details
    document.getElementById('error-time').textContent = new Date().toLocaleString();
    document.getElementById('error-url').textContent = window.location.href;
    document.getElementById('user-agent').textContent = navigator.userAgent.substring(0, 80) + '...';
    document.getElementById('error-id').textContent = generateErrorId();
    document.getElementById('last-update').textContent = new Date().toLocaleString();
    
    // Update system status periodically
    updateSystemStatus();
    setInterval(updateSystemStatus, 30000); // Every 30 seconds
    
    // Animate error code
    const errorCode = document.querySelector('.display-1');
    if (errorCode) {
        errorCode.style.opacity = '0';
        errorCode.style.transform = 'scale(0.5)';
        
        setTimeout(() => {
            errorCode.style.transition = 'all 0.5s ease-out';
            errorCode.style.opacity = '1';
            errorCode.style.transform = 'scale(1)';
        }, 300);
    }
});

// Auto refresh after 2 minutes
setTimeout(() => {
    if (confirm('Hệ thống có thể đã được khôi phục. Bạn có muốn thử tải lại trang không?')) {
        location.reload();
    }
}, 120000);
</script>
{% endblock %}
