
{% extends "base.html" %}

{% block title %}{{ contest.title }} - CoachEduAI{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Contest Header -->
    <div class="card border-0 shadow mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-primary me-2">
                            <i class="fas fa-trophy me-1"></i>Cuộc thi
                        </span>
                        {% if contest.is_official %}
                        <span class="badge bg-warning">
                            <i class="fas fa-star me-1"></i>Chính thức
                        </span>
                        {% endif %}
                    </div>
                    <h1 class="h3 fw-bold mb-2">{{ contest.title }}</h1>
                    <p class="text-muted mb-3">{{ contest.description }}</p>
                    
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-book text-primary me-2"></i>
                                <span>Môn học: <strong>{{ contest.subject_name }}</strong></span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user text-primary me-2"></i>
                                <span>Tác giả: <strong>{{ contest.creator_name }}</strong></span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock text-primary me-2"></i>
                                <span>Thời gian: <strong>{{ contest.duration }} phút</strong></span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-users text-primary me-2"></i>
                                <span>Tham gia: <strong>125 người</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 text-end">
                    <div class="contest-timer mb-3">
                        <div class="text-muted small">Thời gian còn lại</div>
                        <div class="h4 fw-bold text-primary" id="contest-timer">02:45:30</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" onclick="joinContest()">
                            <i class="fas fa-play me-2"></i>Tham gia thi
                        </button>
                        <button class="btn btn-outline-secondary" onclick="viewLeaderboard()">
                            <i class="fas fa-list-ol me-2"></i>Bảng xếp hạng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contest Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">Điểm cao nhất</h5>
                    <p class="h4 text-warning">95/100</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                    <h5 class="card-title">Điểm trung bình</h5>
                    <p class="h4 text-success">72.5/100</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-info mb-2"></i>
                    <h5 class="card-title">Tham gia</h5>
                    <p class="h4 text-info">125</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x text-danger mb-2"></i>
                    <h5 class="card-title">Thời gian TB</h5>
                    <p class="h4 text-danger">45 phút</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contest Exercises -->
    <div class="card border-0 shadow mb-4">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>Danh sách bài tập ({{ contest_exercises|length }} bài)
            </h5>
            {% if contest.created_by == session.user_id %}
            <button class="btn btn-sm btn-primary" onclick="showAddExerciseModal()">
                <i class="fas fa-plus me-1"></i>Thêm bài tập
            </button>
            {% endif %}
        </div>
        <div class="card-body p-0">
            {% if contest_exercises %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="60">#</th>
                            <th>Tên bài</th>
                            <th width="120">Độ khó</th>
                            <th width="100">Điểm</th>
                            <th width="150">Tác giả</th>
                            {% if contest.created_by == session.user_id %}
                            <th width="80">Thao tác</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for exercise in contest_exercises %}
                        <tr class="cursor-pointer">
                            <td><span class="badge bg-primary">{{ loop.index }}</span></td>
                            <td onclick="viewExercise({{ exercise.id }})">
                                <div class="fw-medium">{{ exercise.title }}</div>
                                <small class="text-muted">{{ exercise.content[:50] }}...</small>
                            </td>
                            <td>
                                {% if exercise.difficulty == 'easy' %}
                                <span class="badge bg-success">Dễ</span>
                                {% elif exercise.difficulty == 'medium' %}
                                <span class="badge bg-warning">Trung bình</span>
                                {% else %}
                                <span class="badge bg-danger">Khó</span>
                                {% endif %}
                            </td>
                            <td><span class="fw-medium">{{ exercise.points }}</span></td>
                            <td><small class="text-muted">{{ exercise.author_name }}</small></td>
                            {% if contest.created_by == session.user_id %}
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeExerciseFromContest({{ exercise.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Chưa có bài tập nào</h5>
                <p class="text-muted">
                    {% if contest.created_by == session.user_id %}
                    Hãy thêm bài tập để học viên có thể tham gia contest.
                    {% else %}
                    Contest này chưa có bài tập để làm.
                    {% endif %}
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Leaderboard -->
    <div class="card border-0 shadow">
        <div class="card-header bg-white py-3">
            <h5 class="card-title mb-0">
                <i class="fas fa-medal me-2"></i>Bảng xếp hạng top 10
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="80">Hạng</th>
                            <th>Người chơi</th>
                            <th width="100">Điểm</th>
                            <th width="120">Thời gian</th>
                            <th width="150">Hoàn thành</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function joinContest() {
    if (confirm('Bạn có chắc chắn muốn tham gia cuộc thi này?')) {
        fetch('/api/join_contest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contest_id: {{ contest.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Update button state
                document.querySelector('button[onclick="joinContest()"]').innerHTML = 
                    '<i class="fas fa-check me-2"></i>Đã tham gia';
                document.querySelector('button[onclick="joinContest()"]').disabled = true;
                document.querySelector('button[onclick="joinContest()"]').className = 'btn btn-success btn-lg';
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi tham gia cuộc thi!');
        });
    }
}

function viewLeaderboard() {
    // Show full leaderboard modal or page
    alert('Chức năng xem bảng xếp hạng đầy đủ');
}

function viewExercise(id) {
    // Show exercise detail
    alert('Xem chi tiết bài tập #' + id);
}

// Contest timer
function updateTimer() {
    const timer = document.getElementById('contest-timer');
    // This would be updated with real contest time
    let time = parseInt(timer.dataset.time || 9930); // seconds
    
    setInterval(() => {
        const hours = Math.floor(time / 3600);
        const minutes = Math.floor((time % 3600) / 60);
        const seconds = time % 60;
        
        timer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        time--;
        
        if (time < 0) {
            timer.textContent = 'Đã kết thúc';
            timer.className = 'h4 fw-bold text-danger';
        }
    }, 1000);
}

document.addEventListener('DOMContentLoaded', updateTimer);
</script>
{% endblock %}
